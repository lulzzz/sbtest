update country set Data='{   "countryId" : 1,   "countryName" : "USA",   "states":  [{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 1,    "stateName" : "California",    "abbreviation" : "CA",    "taxesEnabled": true   },{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 2,    "stateName" : "Alaska",    "abbreviation" : "AK",    "taxesEnabled": false   },{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 3,    "stateName" : "Arizona",    "abbreviation" : "AZ",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 4,    "stateName" : "Arkansas",    "abbreviation" : "AR",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 5,    "stateName" : "Colorado",    "abbreviation" : "CO",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 6,    "stateName" : "Connecticut",    "abbreviation" : "CT",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 7,    "stateName" : "Delaware",    "abbreviation" : "DE",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 8,    "stateName" : "Florida",    "abbreviation" : "FL",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 9,    "stateName" : "Georgia",    "abbreviation" : "GA",    "taxesEnabled": false   }   ,{    "EinFormat":"WH-999-999-9999-01", "hasCounties":  false, "stateId" : 10,    "stateName" : "Hawaii",    "abbreviation" : "HI",    "taxesEnabled": true, "uiFormat": "9999999999"   },{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 11,    "stateName" : "Idaho",    "abbreviation" : "ID",    "taxesEnabled": false   },{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 12,    "stateName" : "Illinois",    "abbreviation" : "IL",    "taxesEnabled": false   },{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 13,    "stateName" : "Indiana",    "abbreviation" : "IN",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 14,    "stateName" : "Iowa",    "abbreviation" : "IA",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 15,    "stateName" : "Kansas",    "abbreviation" : "KS",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 16,    "stateName" : "Kentucky",    "abbreviation" : "KY",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 17,    "stateName" : "Louisiana",    "abbreviation" : "LA",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 18,    "stateName" : "Maine",    "abbreviation" : "ME",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 19,    "stateName" : "Maryland",    "abbreviation" : "MD",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 20,    "stateName" : "Massachusetts",    "abbreviation" : "MA",    "taxesEnabled": false   },{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 21,    "stateName" : "Michigan",    "abbreviation" : "MI",    "taxesEnabled": false   },{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 22,    "stateName" : "Minnesota",    "abbreviation" : "MN",    "taxesEnabled": false   },{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 23,    "stateName" : "Mississippi",    "abbreviation" : "MS",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 24,    "stateName" : "Missouri",    "abbreviation" : "MO",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 25,    "stateName" : "Montana",    "abbreviation" : "MT",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 26,    "stateName" : "Nebraska",    "abbreviation" : "NE",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 27,    "stateName" : "Nevada",    "abbreviation" : "NV",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 28,    "stateName" : "New Hampshire",    "abbreviation" : "NH",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 29,    "stateName" : "New Jersey",    "abbreviation" : "NJ",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 30,    "stateName" : "New Mexico",    "abbreviation" : "NM",    "taxesEnabled": false   },{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 31,    "stateName" : "New York",    "abbreviation" : "NY",    "taxesEnabled": false   },{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 32,    "stateName" : "North Carolina",    "abbreviation" : "NC",    "taxesEnabled": false   },{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 33,    "stateName" : "North Dakota",    "abbreviation" : "ND",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 34,    "stateName" : "Ohio",    "abbreviation" : "OH",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 35,    "stateName" : "Oklahoma",    "abbreviation" : "OK",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 36,    "stateName" : "Oregon",    "abbreviation" : "OR",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 37,    "stateName" : "Pennsylvania",    "abbreviation" : "PA",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 38,    "stateName" : "Rhode Island",    "abbreviation" : "RI",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 39,    "stateName" : "South Carolina",    "abbreviation" : "SC",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 40,    "stateName" : "South Dakota",    "abbreviation" : "SD",    "taxesEnabled": false   },{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 41,    "stateName" : "Tennessee",    "abbreviation" : "TN",    "taxesEnabled": false   },{    "EinFormat":"99-999999-9", "hasCounties":  true, "stateId" : 42,    "stateName" : "Texas",    "abbreviation" : "TX",    "taxesEnabled": true   },{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 43,    "stateName" : "Utah",    "abbreviation" : "UT",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 44,    "stateName" : "Vermont",    "abbreviation" : "VT",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 45,    "stateName" : "Virginia",    "abbreviation" : "VA",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 46,    "stateName" : "Washington",    "abbreviation" : "WA",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 47,    "stateName" : "Washington, DC",    "abbreviation" : "DC",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 48,    "stateName" : "West Virginia",    "abbreviation" : "WV",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 49,    "stateName" : "Wisconsin",    "abbreviation" : "WI",    "taxesEnabled": false   }   ,{    "EinFormat":"999-9999-9", "hasCounties":  false, "stateId" : 50,    "stateName" : "Wyoming",    "abbreviation" : "WY",    "taxesEnabled": false   }   ]  }' where CountryId=1;

IF NOT EXISTS(SELECT *
          FROM   INFORMATION_SCHEMA.COLUMNS
          WHERE  TABLE_NAME = 'CompanyTaxState'
                 AND COLUMN_NAME = 'UIAccountNumber')
Alter table CompanyTaxState Add UIAccountNumber varchar(max);
Go

/****** Object:  StoredProcedure [dbo].[GetExtractData]    Script Date: 4/12/2019 9:46:53 PM ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[GetExtractData]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[GetExtractData]
GO
/****** Object:  StoredProcedure [dbo].[GetExtractData]    Script Date: 4/12/2019 9:46:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[GetExtractData]
	@startdate datetime,
	@enddate datetime,
	@depositSchedule int = null,
	@report varchar(max),
	@host uniqueidentifier = null,
	@includeVoids bit = 0,
	@includeHistory bit = 0,
	@state int = null
AS
BEGIN
	declare @startdate1 datetime = @startdate,
	@enddate1 datetime = @enddate,
	@depositSchedule1 int = @depositSchedule,
	@report1 varchar(max)=@report,
	@host1 uniqueidentifier = @host,
	@includeVoids1 bit = @includeVoids,
	@includeHistoryL bit = @includeHistory,
	@stateL int = @state

	select * into #tmpComp
	from
	(
		select c.id CompanyId, host.id FilingCompanyId, c.HostId Host
		from Company c, Company host
		where c.HostId=host.HostId
		and host.IsHostCompany=1
		and c.FileUnderHost=1
		and ((@depositSchedule1 is not null and host.DepositSchedule941=@depositSchedule1) or @depositSchedule1 is null)
		and ((@host1 is not null and c.HostId=@host1) or (@host1 is null))
		and c.StatusId<>3
		union
		select id CompanyId, id FilingCompanyId, HostId Host
		from Company
		where FileUnderHost=0 
		and ((@report1<>'HostWCReport' and ManageEFileForms=1 and ManageTaxPayment=1) or (@report1='HostWCReport'))
		and ((@depositSchedule1 is not null and DepositSchedule941=@depositSchedule1) or @depositSchedule1 is null)
		and ((@host1 is not null and HostId=@host1) or (@host1 is null))
				and ParentId is null
		and StatusId<>3
		union
		select Company.id CompanyId, Parent.id FilingCompanyId, Parent.HostId Host
		from Company, Company Parent
		where Parent.FileUnderHost=0 
		and ((@report1<>'HostWCReport' and Parent.ManageEFileForms=1 and Parent.ManageTaxPayment=1) or (@report1='HostWCReport'))
		and Company.ParentId is not null
		and Company.ParentId=Parent.Id
		and ((@depositSchedule1 is not null and Parent.DepositSchedule941=@depositSchedule1) or @depositSchedule1 is null)
		and ((@host1 is not null and Parent.HostId=@host1) or (@host1 is null))
		and Company.StatusId<>3
	)a
	where ((@stateL is null) or (@stateL is not null and exists(select 'x' from CompanyTaxState cts where cts.CompanyId=a.CompanyId and cts.StateId=@stateL)))

	select 
	(select 
	Host.*, 
	(
		select HostCompany.*		
		from Company HostCompany where Id=List.FilingCompanyId
		for xml path ('HostCompany'), elements, type
	),
	(
		select * from CompanyTaxState where CompanyId=Company.Id
		for xml path ('ExtractTaxState'), ELEMENTS, type
	) States,
	(
		select *
		from
		(select TargetObject as ContactObject from EntityRelation where SourceEntityTypeId=1 and TargetEntityTypeId=4 and SourceEntityId=Host.Id
		Union
		select TargetObject as ContactObject from EntityRelation where SourceEntityTypeId=2 and TargetEntityTypeId=4 and (SourceEntityId=Host.CompanyId or SourceEntityId=Company.Id)
		)a
		for xml path ('ExtractContact'), ELEMENTS, type
	) Contacts,
	(
		select 
			ExtractCompany.*, IG.GroupNo InsuranceGroup, IG.GroupName InsuranceGroupName,
			(
				select *
				from PayrollPayCheck where CompanyId=ExtractCompany.Id 
				and IsVoid=0
				and taxpayday between @startdate1 and @enddate1
				and not exists(select 'x' from PayCheckExtract where PayrollPayCheckId=PayrollPayCheck.Id and [Extract]=@report1 and [Type]=1)
				and InvoiceId is not null
				and not exists (select 'x' from PayrollInvoice where id=PayrollPayCheck.InvoiceId  and TaxesDelayed=1)
				and @report1<>'Report1099'
				and IsHistory<=@includeHistoryL
				and ((@stateL is not null and PayrollPayCheck.STateId=@stateL) or (@stateL is null))
				--and (InvoiceId is null or not exists(select 'x' from PayrollInvoice where id=PayrollPayCheck.InvoiceId and StatusId=5))
				for xml path ('ExtractPayCheck'), ELEMENTS, type
			) PayChecks,
			(
				select *
				 from PayrollPayCheck 
				where CompanyId=ExtractCompany.Id 
				and IsVoid=1 
				and exists(select 'x' from PayCheckExtract where PayrollPayCheckId=PayrollPayCheck.Id and [Extract]=@report1 and [Type]=1)
				and not exists(select 'x' from PayCheckExtract where PayrollPayCheckId=PayrollPayCheck.Id and [Extract]=@report1 and [Type]=2)
				and VoidedOn between @startdate1 and @enddate1
				and year(taxpayday)=year(@startdate1)
				and InvoiceId is not null
				and not exists (select 'x' from PayrollInvoice where id=PayrollPayCheck.InvoiceId  and TaxesDelayed=1)
				and @report1<>'Report1099'
				and ((@stateL is not null and PayrollPayCheck.StateId=@stateL) or (@stateL is null))
				--and (InvoiceId is null or not exists(select 'x' from PayrollInvoice where id=PayrollPayCheck.InvoiceId and StatusId=5))
				for xml path ('ExtractPayCheck'), ELEMENTS, type
			) VoidedPayChecks,
			(
				select *, 
				(select sum(amount) from CheckbookJournal where CompanyId=ExtractCompany.Id and TransactionType=2 and PayeeId=VendorCustomer.Id and EntityType=15 and IsVoid=0 and TransactionDate between @startdate and @enddate) Amount 
				from VendorCustomer
				where CompanyId=ExtractCompany.Id and IsVendor=1 and StatusId=1 and IsVendor1099=1
				and @report1='Report1099'
				for xml path ('ExtractVendor'), ELEMENTS, type
			)Vendors
		from Company ExtractCompany, insuranceGroup IG
		Where 
		ExtractCompany.InsuranceGroupNo = IG.Id
		and ExtractCompany.Id in (select CompanyId from #tmpComp where FilingCompanyId=Company.Id)
		for xml path ('ExtractDBCompany'), Elements, type

	)Companies
	 from
	Company, (select distinct FilingCompanyId, Host from #tmpComp) List, Host
	where Company.Id=List.FilingCompanyId
	and Company.HostId = Host.Id
	--and Host.CompanyId=List.FilingCompanyId
	for xml path('ExtractHostDB'), ELEMENTS, type
	) Hosts,
	(
		select *
		from
		MasterExtracts where ExtractName=@report1 and year(startdate)=year(@startdate1)
		and Id=0
		for xml path ('MasterExtractDB'), ELEMENTS, type
	) History
	for xml path('ExtractResponseDB'), ELEMENTS, type
	
	

END
GO
